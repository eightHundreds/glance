---
name: 修复弹窗初始化隐藏问题
overview: "修复弹窗初始化时应该完全隐藏的问题。目前虽然设置了透明，但元素仍在 DOM 中可能影响用户交互。需要在初始化时使用 display: none 或 visibility: hidden 来完全隐藏，在显示时再恢复。"
todos:
  - id: "1"
    content: "在 setupShadowDOM() 中初始化 container 时添加 display: 'none' 来完全隐藏"
    status: completed
  - id: "2"
    content: "在 show() 方法中，先设置 display: 'block' 再设置 opacity，确保显示时可见"
    status: completed
  - id: "3"
    content: "在 close() 方法中，延迟设置 display: 'none'，等待 opacity 过渡动画完成"
    status: completed
---

# 修复弹窗初始化隐藏问题

## 问题分析

当前在 `previewPanel.ts` 的 `setupShadowDOM()` 方法中，container 初始化时只设置了：

- `opacity: '0'` - 透明
- `pointerEvents: 'none'` - 不接收指针事件

虽然透明且不接收事件，但元素仍在 DOM 中，可能仍占据空间或影响布局。

## 解决方案

在初始化时完全隐藏 container，使用 `display: 'none'` 或通过 CSS 规则控制。有两种方案：

### 方案 1：使用 display 属性（推荐）

- 初始化时设置 `display: 'none'`
- `show()` 时先设置 `display: 'block'`，再设置 `opacity: '1'`
- `close()` 时在动画完成后设置 `display: 'none'`

### 方案 2：使用 CSS 规则

- 在 CSS 中添加 `[data-visible="false"] { display: none; }`
- 初始化时设置 `data-visible="false"`
- `show()` 时设置 `data-visible="true"`
- `close()` 时设置 `data-visible="false"`

推荐使用方案 1，因为更直接且不需要修改 CSS。

## 需要修改的文件

- `src/content/previewPanel.ts`
- `setupShadowDOM()`: 初始化时添加 `display: 'none'`
- `show()`: 显示时先设置 `display: 'block'`，再设置 opacity
- `close()`: 关闭时在 opacity 动画完成后设置 `display: 'none'`（或使用 setTimeout 延迟）

## 实现细节

1. 在 `setupShadowDOM()` 第 340-347 行，container 初始化时添加 `display: 'none'`
2. 在 `show()` 第 218-221 行，先设置 `display: 'block'`，再设置 opacity
3. 在 `close()` 第 290-293 行，使用 setTimeout 延迟设置 `display: 'none'`，等待 opacity 过渡完成（约 160ms）